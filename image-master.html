<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARMS Image Master - ê¸°ë¡ë¬¼ ì§„ë³¸ì„± í™•ë³´ ë° ë§ˆì´í¬ë¡œí•„ë¦„ ìµœì í™”</title>
    <style>
        /* [UI/UX] í…Œë§ˆ ë³€ìˆ˜ */
        :root {
            --primary: #5AC703; --bg: #f5f5f5; --panel: #ffffff;
            --text: #333333; --text-sub: #666666; --border: #e0e0e0;
            --nav-h: 60px;
        }
        [data-theme="dark"] {
            --primary: #bb86fc; --bg: #121212; --panel: #1e1e1e;
            --text: #e0e0e0; --text-sub: #a0a0a0; --border: #333333;
        }
        [data-theme="nordic"] { --primary: #0077b6; --bg: #f0f4f8; --panel: #ffffff; --text: #2b2d42; --border: #dbe2ef; }
        [data-theme="latte"] { --primary: #ddb892; --bg: #fdfbf7; --panel: #ffffff; --text: #604a3e; --border: #e6ccb2; }
        [data-theme="cyber"] { --primary: #00ff41; --bg: #000000; --panel: #0d0d0d; --text: #00ff41; --border: #333333; }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Segoe UI', 'Noto Sans KR', sans-serif; background: var(--bg); color: var(--text); height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; font-size: 13px; }

        /* ê³µí†µ UI */
        .btn { border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 6px; white-space: nowrap; }
        .btn-primary { background: var(--primary); color: #fff; filter: brightness(1.05); }
        .btn-glass { background: rgba(128,128,128,0.15); color: var(--text); }
        .btn-danger { background: #dc3545; color: white; }
        .icon { width: 18px; height: 18px; stroke: currentColor; stroke-width: 2; fill: none; }
        .form-control { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 13px; }

        /* ë ˆì´ì•„ì›ƒ */
        header { background: var(--panel); border-bottom: 1px solid var(--border); height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; }
        main { flex: 1; display: flex; overflow: hidden; position: relative; }
        .panel-left { width: 300px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .panel-center { flex: 1; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; position: relative; }
        .panel-right { width: 340px; background: var(--panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .mobile-nav { display: none; height: var(--nav-h); background: var(--panel); border-top: 1px solid var(--border); flex-shrink: 0; justify-content: space-around; align-items: center; z-index: 100; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-sub); font-size: 10px; gap: 4px; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; background: rgba(128,128,128,0.05); }
        .nav-item svg { width: 20px; height: 20px; }

        /* íŒŒì¼ ë¦¬ìŠ¤íŠ¸ & íƒ­ */
        .file-list { flex: 1; overflow-y: auto; }
        .file-item { padding: 12px 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--panel); }
        .file-item.selected { background: rgba(128,128,128,0.1); border-left: 4px solid var(--primary); }
        .badge { padding: 3px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; color: white; }
        .st-normal { background: #198754; } .st-changed { background: #dc3545; }

        /* ìº”ë²„ìŠ¤ */
        .canvas-wrap { box-shadow: 0 5px 15px rgba(0,0,0,0.2); border: 1px solid var(--border); background: #fff; max-width: 100%; max-height: 100%; display: flex; }
        canvas { max-width: 100%; max-height: calc(100vh - 140px); object-fit: contain; }
        .preview-msg { position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.6); color: white; padding: 6px 10px; border-radius: 4px; pointer-events: none; font-size: 11px; }

        /* íƒ­ ë° ì„¤ì • */
        .tabs { display: flex; border-bottom: 1px solid var(--border); height: 45px; }
        .tab-btn { flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; border-bottom: 3px solid transparent; color: var(--text-sub); font-weight: 600; }
        .tab-btn.active { border-bottom-color: var(--primary); color: var(--primary); background: rgba(128,128,128,0.05); }
        .tab-content { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 11px; font-weight: 600; color: var(--text-sub); margin-bottom: 5px; }
        .range-wrap { display: flex; align-items: center; gap: 8px; }
        input[type="range"] { flex: 1; accent-color: var(--primary); height: 4px; }
        .text-config-box { border: 1px solid var(--border); border-radius: 6px; padding: 10px; margin-bottom: 10px; background: rgba(128,128,128,0.05); }
        .coord-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }

        /* ğŸ“± ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            header h1 span { display: none; }
            main { flex: 1; position: relative; }
            .panel-left, .panel-center, .panel-right { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; display: none; z-index: 10; }
            .panel-left.mobile-active, .panel-center.mobile-active, .panel-right.mobile-active { display: flex; }
            .mobile-nav { display: flex; }
            canvas { max-height: calc(100dvh - 180px); }
        }

        /* ë¡œë”© */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 9999; display: none; justify-content: center; align-items: center; color: white; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:12px;">
        <a href="/" style="display:flex; align-items:center; justify-content:center; width:32px; height:32px; background:rgba(128,128,128,0.1); border-radius:8px; color:var(--text); text-decoration:none;">
            <svg class="icon" viewBox="0 0 24 24"><path d="M19 12H5"/><polyline points="12 19 5 12 12 5"/></svg>
        </a>
        <h1 style="font-size:16px; margin:0; display:flex; flex-direction:column; justify-content:center;">
            <div style="font-weight:900;">ARMS Image Master</div>
            <div style="font-size:10px; font-weight:400; color:var(--text-sub);">ê¸°ë¡ë¬¼ ë³´ì¡´ë§¤ì²´ ìˆ˜ë¡ìš© ì „ì²˜ë¦¬ ë„êµ¬</div>
        </h1>
    </div>
    <div style="display:flex; gap:8px;">
        <select id="themeSelect" class="form-control" style="width:auto;" onchange="app.setTheme(this.value)">
            <option value="naver">Green</option><option value="dark">Dark</option><option value="nordic">Blue</option><option value="latte">Latte</option><option value="cyber">Cyber</option>
        </select>
        <button class="btn btn-primary" onclick="document.getElementById('folderInput').click()">í´ë” ì—´ê¸°</button>
    </div>
    <input type="file" id="folderInput" webkitdirectory multiple style="display:none" onchange="app.handleFiles(this.files)">
</header>

<main>
    <div class="panel-left mobile-active" id="view-list">
        <div style="padding:12px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
            <span id="fileCount" style="font-weight:bold;">íŒŒì¼ 0ê°œ</span>
            <button class="btn btn-glass" onclick="app.clearAll()">ì´ˆê¸°í™”</button>
        </div>
        <div class="file-list" id="fileListArea">
            <div style="padding:30px; text-align:center; color:var(--text-sub); line-height:1.6;">
                <svg class="icon" style="width:40px; height:40px; opacity:0.3; margin-bottom:10px;" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg><br>
                ìƒë‹¨ 'í´ë” ì—´ê¸°'ë¥¼ ëˆŒëŸ¬<br>ê¸°ë¡ë¬¼ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.<br><br>
                <span style="font-size:11px; background:rgba(255,193,7,0.2); padding:4px 8px; border-radius:4px; color:#d68b00;">* PC í™˜ê²½ ê¶Œì¥ (í´ë” ì²˜ë¦¬)</span>
            </div>
        </div>
    </div>

    <div class="panel-center" id="view-preview">
        <div class="canvas-wrap">
            <canvas id="previewCanvas"></canvas>
        </div>
        <div class="preview-msg" id="previewInfo">ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì—¬ ë©”íƒ€ë°ì´í„° ìŠ¤íƒ¬í•‘ í™•ì¸</div>
        <button class="btn btn-primary" style="position:absolute; top:20px; right:20px; box-shadow:0 2px 10px rgba(0,0,0,0.2);" onclick="app.saveCurrentPreview()">
            <svg class="icon" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            í˜„ì¬ ì»· ì €ì¥
        </button>
    </div>

    <div class="panel-right" id="view-settings">
        <div class="tabs">
            <div class="tab-btn active" onclick="app.switchSettingTab('convert')">ë³€í™˜/ì›Œí„°ë§ˆí¬</div>
            <div class="tab-btn" onclick="app.switchSettingTab('integrity')">ì§„ë³¸ì„± ê²€ì¦</div>
        </div>

        <div id="tab-convert" class="tab-content active">
            <div style="margin-bottom:15px; padding:10px; background:rgba(0,123,255,0.05); border:1px solid rgba(0,123,255,0.1); border-radius:6px;">
                <h4 style="margin:0 0 5px 0; font-size:12px; color:var(--primary);">ë§ˆì´í¬ë¡œí•„ë¦„ ìˆ˜ë¡ ìš”ê±´ ì¶©ì¡±</h4>
                <p style="margin:0; font-size:11px; color:var(--text-sub);">
                    ê¸°ë¡ë¬¼ì˜ ë§¥ë½ ì •ë³´(íŒŒì¼ëª…, ì¼ì ë“±)ë¥¼ ì´ë¯¸ì§€ ì—¬ë°±ì— ì˜êµ¬ì ìœ¼ë¡œ ê°ì¸í•˜ì—¬, í•„ë¦„ ë³€í™˜ ì‹œ ë²•ì  ì¦ê±° ëŠ¥ë ¥ì„ í™•ë³´í•©ë‹ˆë‹¤.
                </p>
            </div>

            <div class="form-group">
                <label class="form-label">ì¶œë ¥ ê·œê²© (ìš©ì§€/DPI/íšŒì „)</label>
                <div style="display:flex; gap:5px; margin-bottom:8px;">
                    <select id="cfg_paper" class="form-control" onchange="app.updatePreview()"><option value="A4">A4 (í‘œì¤€)</option><option value="A3">A3 (ë„ë©´ìš©)</option><option value="B4">B4</option></select>
                    <select id="cfg_dpi_select" class="form-control" onchange="app.toggleCustomDPI(); app.updatePreview()"><option value="150">150 dpi</option><option value="300" selected>300 dpi (ë³´ì¡´ìš©)</option><option value="600">600 dpi</option><option value="custom">ì§ì ‘ì…ë ¥</option></select>
                    <button class="btn btn-glass" style="padding:8px;" onclick="app.rotate(90)" title="90ë„ íšŒì „">â†»</button>
                </div>
                <input type="number" id="cfg_dpi_custom" class="form-control" style="display:none;" value="300" placeholder="DPI" oninput="app.updatePreview()">
            </div>

            <div class="form-group" style="background:rgba(128,128,128,0.05); padding:10px; border-radius:6px; border:1px solid var(--border);">
                <label class="form-label" style="color:var(--primary);">ë³´ì¡´ìš© ì´ë¯¸ì§€ ìµœì í™”</label>
                
                <div class="range-wrap" style="margin-bottom:8px;">
                    <span style="font-size:10px; width:45px;">í¬ê¸°(%)</span>
                    <input type="range" id="cfg_img_scale" min="10" max="150" value="95" oninput="app.updatePreview()">
                    <span id="val_img_scale" style="font-size:10px; width:30px; text-align:right;">95%</span>
                </div>
                
                <div style="display:flex; gap:5px;">
                    <select id="cfg_align_h" class="form-control" onchange="app.updatePreview()">
                        <option value="center">ê°€ë¡œ: ì¤‘ì•™ ì •ë ¬</option>
                        <option value="left">ê°€ë¡œ: ì™¼ìª½ ì •ë ¬</option>
                        <option value="right">ê°€ë¡œ: ì˜¤ë¥¸ìª½ ì •ë ¬</option>
                    </select>
                    <select id="cfg_align_v" class="form-control" onchange="app.updatePreview()">
                        <option value="middle">ì„¸ë¡œ: ì¤‘ì•™ ì •ë ¬</option>
                        <option value="top">ì„¸ë¡œ: ìƒë‹¨ ì •ë ¬</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">ë©”íƒ€ë°ì´í„° ìŠ¤íƒ¬í•‘ (ì§„ë³¸ì„± í™•ë³´)</label>
                <div class="range-wrap" style="margin-bottom:10px;">
                    <span style="font-size:11px;">í•˜ë‹¨ ì—¬ë°± í™•ë³´</span>
                    <input type="range" id="cfg_padBot" min="0" max="40" value="10" oninput="app.updatePreview()">
                    <span id="val_padBot" style="font-size:11px; width:35px; text-align:right;">10%</span>
                </div>
                
                <div class="text-config-box">
                    <div class="text-config-header" style="color:var(--primary); font-weight:bold; margin-bottom:5px;">[ì¢Œì¸¡] ë¬¸ì„œ ê³ ìœ ë²ˆí˜¸</div>
                    <select id="cfg_txt_L_type" class="form-control" onchange="app.updatePreview()"><option value="filename">íŒŒì¼ëª… (ë¬¸ì„œë²ˆí˜¸)</option><option value="date">ìŠ¤ìº” ì¼ì</option><option value="seq">ì¼ë ¨ë²ˆí˜¸</option><option value="none">ì—†ìŒ</option></select>
                    <input type="text" id="cfg_txt_L_val" class="form-control" style="display:none; margin-top:5px;" oninput="app.updatePreview()">
                </div>
                
                <div class="text-config-box">
                    <div class="text-config-header" style="color:var(--primary); font-weight:bold; margin-bottom:5px;">[ì¤‘ì•™] ìƒì‚° ì •ë³´</div>
                    <select id="cfg_txt_C_type" class="form-control" onchange="app.updatePreview()"><option value="custom">ê¸°ê´€ëª… ì§ì ‘ì…ë ¥</option><option value="date">ìƒì‚° ì¼ì</option><option value="none">ì—†ìŒ</option></select>
                    <input type="text" id="cfg_txt_C_val" class="form-control" style="margin-top:5px;" value="OOì‹œì²­ ê¸°ë¡ê´€" oninput="app.updatePreview()">
                </div>
                
                <div class="text-config-box">
                    <div class="text-config-header" style="color:var(--primary); font-weight:bold; margin-bottom:5px;">[ìš°ì¸¡] ìª½ìˆ˜/ë³´ì•ˆ</div>
                    <select id="cfg_txt_R_type" class="form-control" onchange="app.updatePreview()"><option value="seq">ì¼ë ¨ë²ˆí˜¸ (Page)</option><option value="custom">ë³´ì•ˆë“±ê¸‰</option><option value="none">ì—†ìŒ</option></select>
                    <input type="text" id="cfg_txt_R_val" class="form-control" style="display:none; margin-top:5px;" oninput="app.updatePreview()">
                </div>
            </div>

            <div class="form-group" style="margin-top:20px;">
                <button class="btn btn-primary" style="width:100%; padding:12px;" onclick="app.startBatchConvert()">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    ì¼ê´„ ë³€í™˜ ë° PC ì €ì¥
                </button>
                <div style="font-size:10px; color:var(--text-sub); text-align:center; margin-top:5px;">* ìˆ˜ì²œ ì¥ì˜ ì´ë¯¸ì§€ë¥¼ í‘œì¤€ í¬ë§·ìœ¼ë¡œ ìë™ ë³€í™˜í•©ë‹ˆë‹¤.</div>
            </div>
        </div>

        <div id="tab-integrity" class="tab-content">
            <div style="margin-bottom:15px; padding:10px; background:rgba(220,53,69,0.05); border:1px solid rgba(220,53,69,0.1); border-radius:6px;">
                 <h4 style="margin:0 0 5px 0; font-size:12px; color:#dc3545;">ë¬´ê²°ì„±(Integrity) ê²€ì¦</h4>
                 <p style="margin:0; font-size:11px; color:var(--text-sub);">
                     ì›ë³¸ ìŠ¤ìº” íŒŒì¼ê³¼ ë³€í™˜ëœ íŒŒì¼ì˜ í•´ì‹œê°’(SHA-256)ì„ ê´€ë¦¬í•˜ì—¬, ë°ì´í„°ì˜ ìœ„ë³€ì¡° ì—¬ë¶€ë¥¼ ê¸°ìˆ ì ìœ¼ë¡œ ì¦ëª…í•©ë‹ˆë‹¤.
                 </p>
            </div>
            <button class="btn btn-glass" style="width:100%; margin-bottom:10px;" onclick="app.createSnapshot()">1. ê¸°ì¤€ ë°ì´í„° ìƒì„± (í•´ì‹œ ì¶”ì¶œ)</button>
            <button class="btn btn-danger" style="width:100%; margin-bottom:15px;" onclick="document.getElementById('verifyInput').click()">2. ìœ„ë³€ì¡° ê²€ì¦ ìˆ˜í–‰</button>
            <input type="file" id="verifyInput" accept=".csv" style="display:none" onchange="app.verifyIntegrity(this.files[0])">
            <div id="verifyResult" style="display:none; padding:10px; background:rgba(0,0,0,0.05); border-radius:6px;">
                <div>ì •ìƒ(ì›ë³¸ìœ ì§€): <b id="cnt_normal" style="color:#198754">0</b></div>
                <div>ë³€ì¡°(ìœ„í—˜): <b id="cnt_changed" style="color:#dc3545">0</b></div>
                <div>ì‹ ê·œ: <b id="cnt_new" style="color:#ffc107">0</b></div>
                <div>ì‚­ì œ: <b id="cnt_deleted" style="color:#fd7e14">0</b></div>
                <button class="btn btn-glass" style="width:100%; margin-top:10px;" onclick="app.downloadVerifyReport()">ê²€ì¦ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </div>
    </div>
</main>

<nav class="mobile-nav">
    <div class="nav-item active" onclick="app.mobileNav('list', this)"><svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>íŒŒì¼ëª©ë¡</div>
    <div class="nav-item" onclick="app.mobileNav('preview', this)"><svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>ë¯¸ë¦¬ë³´ê¸°</div>
    <div class="nav-item" onclick="app.mobileNav('settings', this)"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>ì„¤ì •</div>
</nav>

<div class="overlay" id="loadingOverlay"><div class="spinner"></div><div id="loadingMsg" style="margin-top:10px;">ì²˜ë¦¬ ì¤‘...</div></div>

<script>
const app = {
    state: { files: [], selectedId: null, rotation: 0, verifyResultList: [], theme: 'naver' },
    init: () => {
        app.loadPreset();
        const area = document.getElementById('fileListArea');
        area.addEventListener('dragover', e => e.preventDefault());
        area.addEventListener('drop', e => { e.preventDefault(); app.handleFiles(e.dataTransfer.files); });
    },
    setTheme: (t) => { app.state.theme = t; document.documentElement.setAttribute('data-theme', t); },
    mobileNav: (viewName, el) => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); el.classList.add('active');
        document.querySelectorAll('.panel-left, .panel-center, .panel-right').forEach(p => p.classList.remove('mobile-active'));
        document.getElementById(`view-${viewName}`).classList.add('mobile-active');
    },
    handleFiles: async (fileList) => {
        app.showLoading(true);
        const newFiles = Array.from(fileList).filter(f => f.type.startsWith('image/')).map(f => ({ id: Math.random().toString(36).substr(2,9), file: f, name: f.name, size: f.size, status: 'wait' }));
        app.state.files.push(...newFiles);
        const area = document.getElementById('fileListArea');
        if(area.innerHTML.includes('í´ë” ì—´ê¸°')) area.innerHTML = '';
        newFiles.forEach(f => {
            const div = document.createElement('div'); div.className = 'file-item'; div.dataset.id = f.id; div.onclick = () => app.selectFile(f.id);
            div.innerHTML = `<span style="font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${f.name}</span><div id="badge_${f.id}"></div>`;
            area.appendChild(div);
        });
        document.getElementById('fileCount').innerText = `íŒŒì¼ ${app.state.files.length}ê°œ`;
        if(!app.state.selectedId && app.state.files.length>0) app.selectFile(app.state.files[0].id);
        app.showLoading(false);
    },
    selectFile: async (id) => {
        if(app.state.selectedId) document.querySelector(`.file-item[data-id="${app.state.selectedId}"]`)?.classList.remove('selected');
        app.state.selectedId = id;
        document.querySelector(`.file-item[data-id="${id}"]`)?.classList.add('selected');
        const f = app.state.files.find(x => x.id === id);
        if(f && !f.dims) { const img = await app.loadImage(f.file); f.dims = { w: img.width, h: img.height }; }
        app.updatePreview();
        if(window.innerWidth <= 768) app.mobileNav('preview', document.querySelectorAll('.nav-item')[1]);
    },
    clearAll: () => {
        app.state.files = []; app.state.selectedId = null;
        document.getElementById('fileListArea').innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-sub);">í´ë”ë¥¼ ì—´ì–´ ê¸°ë¡ë¬¼ ì´ë¯¸ì§€ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</div>';
        document.getElementById('fileCount').innerText = 'íŒŒì¼ 0ê°œ';
        const ctx = document.getElementById('previewCanvas').getContext('2d'); ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
        document.getElementById('previewInfo').innerText = 'ì¤€ë¹„ë¨';
    },
    loadImage: (src) => new Promise((res, rej) => { const img = new Image(); img.onload = () => res(img); img.onerror = rej; img.src = (typeof src === 'string') ? src : URL.createObjectURL(src); }),
    getDPI: () => { const sel = document.getElementById('cfg_dpi_select').value; return (sel === 'custom') ? Number(document.getElementById('cfg_dpi_custom').value) : Number(sel); },
    toggleCustomDPI: () => {
        const isCustom = document.getElementById('cfg_dpi_select').value === 'custom';
        document.getElementById('cfg_dpi_custom').style.display = isCustom ? 'block' : 'none';
        ['L','C','R'].forEach(pos => { const type = document.getElementById(`cfg_txt_${pos}_type`).value; document.getElementById(`cfg_txt_${pos}_val`).style.display = (type === 'custom') ? 'block' : 'none'; });
    },
    rotate: (deg) => { app.state.rotation = (app.state.rotation + deg) % 360; app.updatePreview(); },
    renderToCanvas: async (canvas, fileObj, isThumb) => {
        const ctx = canvas.getContext('2d');
        const dpi = app.getDPI();
        const paperMap = { 'A4':[210,297], 'A3':[297,420], 'B4':[250,353] };
        const [mmW, mmH] = paperMap[document.getElementById('cfg_paper').value] || [210,297];
        const pxW = Math.floor(mmW/25.4*dpi), pxH = Math.floor(mmH/25.4*dpi);
        canvas.width = pxW; canvas.height = pxH;
        ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,pxW,pxH);

        const img = await app.loadImage(fileObj.file);
        const padBotPct = document.getElementById('cfg_padBot').value;
        const textAreaH = pxH * (padBotPct / 100), imgAreaH = pxH - textAreaH;

        // [New] Size & Align
        const scalePct = document.getElementById('cfg_img_scale').value;
        const alignH = document.getElementById('cfg_align_h').value;
        const alignV = document.getElementById('cfg_align_v').value;

        // Bounding Box Calculation
        const isRotated = Math.abs(app.state.rotation)%180 === 90;
        const srcW = isRotated ? img.height : img.width;
        const srcH = isRotated ? img.width : img.height;
        const fitScale = Math.min(pxW / srcW, imgAreaH / srcH);
        
        // Apply User Scale
        const finalScale = fitScale * (scalePct / 100);
        const drawW = srcW * finalScale;
        const drawH = srcH * finalScale;

        // Determine Position
        let posX = 0, posY = 0;
        if(alignH === 'center') posX = (pxW - drawW) / 2;
        else if(alignH === 'right') posX = pxW - drawW;
        
        if(alignV === 'middle') posY = (imgAreaH - drawH) / 2;
        else if(alignV === 'bottom') posY = imgAreaH - drawH;

        ctx.save();
        const centerX = posX + drawW/2;
        const centerY = posY + drawH/2;
        ctx.translate(centerX, centerY);
        ctx.rotate(app.state.rotation * Math.PI / 180);
        
        // No heavy filters for archival purposes (preservation quality)
        
        const renderW = isRotated ? drawH : drawW;
        const renderH = isRotated ? drawW : drawH;
        ctx.drawImage(img, -renderW/2, -renderH/2, renderW, renderH);
        ctx.restore();

        if(padBotPct > 0) {
            ctx.strokeStyle = '#ccc'; ctx.lineWidth = Math.max(1, dpi/150);
            ctx.beginPath(); ctx.moveTo(0, imgAreaH); ctx.lineTo(pxW, imgAreaH); ctx.stroke();
            const fontSize = Math.max(12, pxW/50); // Slightly smaller font for metadata
            ctx.font = `500 ${fontSize}px "Malgun Gothic", sans-serif`;
            ctx.fillStyle = '#000'; ctx.textBaseline = 'middle';
            const baseY = imgAreaH + (textAreaH/2), margin = pxW * 0.05;
            const drawTxt = (pos, align, baseX) => {
                const type = document.getElementById(`cfg_txt_${pos}_type`).value;
                if(type === 'none') return;
                let text = '';
                if(type === 'filename') text = fileObj.name;
                else if(type === 'date') text = new Date(fileObj.file.lastModified).toISOString().slice(0,10);
                else if(type === 'seq') {
                    const idx = app.state.files.indexOf(fileObj);
                    text = String(1 + idx).padStart(4, '0');
                } else if(type === 'custom') text = document.getElementById(`cfg_txt_${pos}_val`).value;
                
                // Add static offsets for simplicity in this demo
                ctx.textAlign = align; ctx.fillText(text, baseX, baseY);
            };
            drawTxt('L', 'left', margin); drawTxt('C', 'center', pxW/2); drawTxt('R', 'right', pxW - margin);
        }
        if(isThumb) {
            document.getElementById('previewInfo').innerText = `${pxW}x${pxH}px / ${dpi}DPI (ê¸°ë¡ë¬¼ ë³´ì¡´ í‘œì¤€)`;
            document.getElementById('val_padBot').innerText = padBotPct+'%';
            document.getElementById('val_img_scale').innerText = scalePct+'%';
            ['L','C','R'].forEach(p => app.toggleCustomDPI());
        }
    },
    updatePreview: async () => {
        if(!app.state.selectedId) return;
        const f = app.state.files.find(x => x.id === app.state.selectedId);
        await app.renderToCanvas(document.getElementById('previewCanvas'), f, true);
    },
    saveCurrentPreview: () => {
        document.getElementById('previewCanvas').toBlob(blob => {
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Preservation_${Date.now()}.jpg`; link.click();
        }, 'image/jpeg', 0.95);
    },
    startBatchConvert: async () => {
        if(app.state.files.length === 0) return alert('íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
        if(!window.showDirectoryPicker) return alert('ëª¨ë°”ì¼ì—ì„œëŠ” í´ë” ì €ì¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì»·ë³„ ì €ì¥ì„ ì´ìš©í•´ì£¼ì„¸ìš”.');
        try {
            const handle = await window.showDirectoryPicker();
            const resultDir = await handle.getDirectoryHandle('Converted_Microfilm', {create:true});
            app.showLoading(true); const canvas = document.createElement('canvas');
            for(let i=0; i<app.state.files.length; i++) {
                await app.renderToCanvas(canvas, app.state.files[i], false);
                const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.95));
                const fh = await resultDir.getFileHandle(`MF_${app.state.files[i].name.replace(/\..+$/, "")}.jpg`, {create:true});
                const wr = await fh.createWritable(); await wr.write(blob); await wr.close();
                document.getElementById(`badge_${app.state.files[i].id}`).className = 'badge st-normal'; document.getElementById(`badge_${app.state.files[i].id}`).innerText = 'ì™„ë£Œ';
            }
            app.showLoading(false); alert('ë³€í™˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë§ˆì´í¬ë¡œí•„ë¦„ ì¶œë ¥ìš© í´ë”ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        } catch(e) { app.showLoading(false); alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message); }
    },
    calculateHash: async (file) => { const b = await file.arrayBuffer(); const h = await crypto.subtle.digest('SHA-256', b); return Array.from(new Uint8Array(h)).map(x => x.toString(16).padStart(2,'0')).join(''); },
    createSnapshot: async () => {
        if(app.state.files.length===0) return alert('íŒŒì¼ ì—†ìŒ'); app.showLoading(true);
        let csv = "\uFEFFíŒŒì¼ëª…,í¬ê¸°,SHA-256\n"; for(const f of app.state.files) csv += `${f.name},${f.size},${await app.calculateHash(f.file)}\n`;
        app.showLoading(false); const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = `Hash_Snapshot_${new Date().toISOString().slice(0,10)}.csv`; a.click();
    },
    verifyIntegrity: (file) => {
        if(!file) return; const r = new FileReader();
        r.onload = async (e) => {
            const map = new Map(); e.target.result.split('\n').slice(1).forEach(l => { const c = l.split(','); if(c.length>=3) map.set(c[0], c[2].trim()); });
            let s = {ok:0, ch:0, new:0, del:0}; app.state.verifyResultList = [];
            for(const f of app.state.files) {
                app.showLoading(true); const h = await app.calculateHash(f.file); let st = 'new'; if(map.has(f.name)) st = (map.get(f.name)===h)?'normal':'changed';
                s[st==='normal'?'ok':(st==='changed'?'ch':'new')]++; document.getElementById(`badge_${f.id}`).className = `badge st-${st}`; app.state.verifyResultList.push({name:f.name, status:st});
            }
            app.showLoading(false); document.getElementById('verifyResult').style.display = 'block';
            document.getElementById('cnt_normal').innerText = s.ok; document.getElementById('cnt_changed').innerText = s.ch; document.getElementById('cnt_new').innerText = s.new;
        }; r.readAsText(file);
    },
    downloadVerifyReport: () => { let csv = "\uFEFFìƒíƒœ,íŒŒì¼ëª…\n"; app.state.verifyResultList.forEach(r => csv += `${r.status},${r.name}\n`); const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = `Verify_Report.csv`; a.click(); },
    switchSettingTab: (id) => { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.querySelector(`.tab-btn[onclick*="${id}"]`).classList.add('active'); document.getElementById(`tab-${id}`).classList.add('active'); },
    loadPreset: () => {
        // ê¸°ë³¸ê°’ ë¡œë“œ (ê¸°ë¡ê´€ë¦¬ ìµœì í™”)
        document.getElementById('cfg_paper').value = 'A4';
        document.getElementById('cfg_dpi_select').value = '300';
        document.getElementById('cfg_padBot').value = '10';
        app.toggleCustomDPI();
    },
    showLoading: (on) => document.getElementById('loadingOverlay').style.display = on?'flex':'none'
};
window.onload = app.init;
</script>
</body>
</html>